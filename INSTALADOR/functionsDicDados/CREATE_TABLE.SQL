CREATE OR REPLACE FUNCTION comp.create_table(id_table numeric, id_application numeric, nm_schema character varying)
 RETURNS void
 LANGUAGE plpgsql
AS $function$
DECLARE

REC 			RECORD;
SUB_REC			RECORD;
TEXT_W 			VARCHAR(16000) := '';
TABLE_NAME_W 	VARCHAR(50);
MASTER_LOG_ID	NUMERIC;
MASTER_LOG_SCHEMA NUMERIC;

BEGIN

SELECT 	A.NAME 
INTO 	TABLE_NAME_W 
FROM 	COMP.SYSTEM_TABLE A 
WHERE 	A.ID = $1;

TEXT_W := 'CREATE TABLE ' || $3 || '.' || TABLE_NAME_W || '(';

FOR REC IN
	SELECT 	A.NAME, 
		COMP.GET_EXPRESSION_TEXT(B.ID_EXPRESSION) ATTRIBUTE_TYPE,
		A.VL_ATTRIBUTE_SIZE ATTRIBUTE_SIZE,
		A.VL_DECIMAL_SIZE DECIMAL_SIZE,
		A.FL_NOT_NULL REQUIRED,
		A.VL_DEFAULT DEFAULT_VALUE,
		A.VL_DECIMAL_SIZE DECIMAL_SIZE
	FROM  	COMP.TABLE_ATTRIBUTE A,
		COMP.DOMAIN_VALUE B,
		COMP.SYSTEM_TABLE C
	WHERE	A.ID_DOMAIN_VALUE_TYPE = B.ID
	AND	A.ID_TABLE = C.ID
	AND	A.ID_TABLE = $1
LOOP
	TEXT_W := TEXT_W || REC.NAME || ' ' || REC.ATTRIBUTE_TYPE;

	IF (REC.ATTRIBUTE_SIZE > 0) THEN
		TEXT_W := TEXT_W || '(' || REC.ATTRIBUTE_SIZE;

		IF (REC.DECIMAL_SIZE >= 0) THEN
			TEXT_W := TEXT_W || ',' || REC.DECIMAL_SIZE;
		END IF;

		TEXT_W := TEXT_W || ')';		
	END IF;
	
	IF (REC.DEFAULT_VALUE <> '') THEN
		IF ((COMP.IS_NUMBER(REC.DEFAULT_VALUE)) OR (REC.DEFAULT_VALUE = 'CURRENT_DATE') OR (REC.DEFAULT_VALUE = 'CURRENT_TIMESTAMP')) THEN
			TEXT_W := TEXT_W || ' DEFAULT ' || REC.DEFAULT_VALUE;
		ELSE
			TEXT_W := TEXT_W || ' DEFAULT ''' || REC.DEFAULT_VALUE || '''';
		END IF;
	END IF;

	IF (REC.REQUIRED IS TRUE) THEN
		TEXT_W := TEXT_W || ' NOT NULL';
	END IF;

	TEXT_W := TEXT_W || ', '; 
END LOOP;
TEXT_W := SUBSTRING(TEXT_W FROM 1 FOR (CHAR_LENGTH(TEXT_W) -2));

TEXT_W := TEXT_W || ');';

PERFORM COMP.EXECUTE_STATEMENT(TEXT_W);

END;
$function$
