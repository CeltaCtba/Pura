CREATE OR REPLACE FUNCTION comp.get_macro_text(id_expression numeric, expression_list character varying[])
  RETURNS character varying AS
$BODY$
DECLARE
TEXT_W 		CHARACTER VARYING := '';
TEXT_AUX_1 	CHARACTER VARYING := '';
TEXT_AUX_2 	CHARACTER VARYING := '';
SUBTXT		CHARACTER VARYING ;
VINIPOS		INTEGER;
VENDPOS		INTEGER;
BEGIN

SELECT	A.DS_POR
INTO	TEXT_W
FROM	COMP.EXPRESSION A
WHERE	1=1
AND 	A.ID = $1;

if(expression_list is not null and POSITION('#$' IN TEXT_W) > 0) then
	FOR SUBTXT IN 
		SELECT UNNEST(EXPRESSION_LIST) AS FIELD
	LOOP
		VINIPOS := POSITION('#$' IN TEXT_W);

		IF (VINIPOS <> 0) THEN
			TEXT_AUX_1 	:= SUBSTRING(TEXT_W FROM 1 FOR VINIPOS-1) || '$1';
			TEXT_AUX_1 	:= REPLACE(TEXT_AUX_1,'$1',SUBTXT);

			TEXT_AUX_2 	:= SUBSTRING(TEXT_W FROM VINIPOS+2 FOR 4000);
			VINIPOS 	:= POSITION('#$' IN TEXT_AUX_2);
			TEXT_AUX_2	:= SUBSTRING(TEXT_AUX_2 FROM VINIPOS+2 FOR 4000);
		END IF;

		TEXT_W := TEXT_AUX_1 || TEXT_AUX_2;
	END LOOP;
end if;

RETURN TEXT_W;

END;
$BODY$
  LANGUAGE plpgsql VOLATILE
  COST 100;
