CREATE OR REPLACE FUNCTION comp.alter_attribute(attribute_id numeric, change_option character varying, id_application numeric, nm_schema character varying)
  RETURNS void AS
$BODY$
DECLARE
/*
VALUES OF CHANGE_OPTION:
REQUIRED
DEFAULT VALUE
CHARACTER SIZE
NUMERIC SIZE
*/

TEXT_W 			VARCHAR(4000) := '';
TABLE_NAME_W		VARCHAR(50);
ATTRIBUTE_NAME_W	VARCHAR(50);
ATTRIBUTE_TYPE_W	VARCHAR(40);
ATTRIBUTE_ID_W		NUMERIC;
ATTRIBUTE_SIZE_W	INTEGER;
DECIMAL_SIZE_W		INTEGER;
REQUIRED_W		BOOLEAN;
DEFAULT_VALUE_W		VARCHAR(50);

BEGIN

SELECT 	A.ID,
		A.NAME TABLE_NAME, 
		B.NAME ATTRIBUTE_NAME,
		COMP.GET_EXPRESSION_TEXT(C.ID_EXPRESSION, $3) ATTRIBUTE_TYPE,
		COALESCE(B.VL_ATTRIBUTE_SIZE,0),
		COALESCE(B.VL_DECIMAL_SIZE,0),
		B.FL_NOT_NULL,
		B.VL_DEFAULT
INTO	ATTRIBUTE_ID_W,
		TABLE_NAME_W, 	
		ATTRIBUTE_NAME_W,
		ATTRIBUTE_TYPE_W,
		ATTRIBUTE_SIZE_W,
		DECIMAL_SIZE_W,
		REQUIRED_W,
		DEFAULT_VALUE_W
FROM 	COMP.SYSTEM_TABLE A,
	COMP.TABLE_ATTRIBUTE B,
	COMP.DOMAIN_VALUE C
WHERE 	A.ID = B.ID_TABLE
AND	B.ID_DOMAIN_VALUE_TYPE = C.ID
AND	B.ID = $1
AND A.ID_APPLICATION = $3;

PERFORM COMP.EXECUTE_SCRIPT_VERSION($1,ATTRIBUTE_ID_W);

TEXT_W := 'ALTER TABLE ' || $4 || '.' || TABLE_NAME_W;

IF ('REQUIRED' = $2) THEN
	IF (REQUIRED_W IS TRUE) THEN
		TEXT_W := TEXT_W || ' ALTER COLUMN ' || ATTRIBUTE_NAME_W || ' SET NOT NULL ';
	ELSE
		TEXT_W := TEXT_W || ' ALTER COLUMN ' || ATTRIBUTE_NAME_W || ' DROP NOT NULL ';
	END IF;	
ELSIF ('DEFAULT VALUE' = $2) THEN
	IF (DEFAULT_VALUE_W IS NULL) THEN
		TEXT_W := TEXT_W || ' ALTER COLUMN ' || ATTRIBUTE_NAME_W || ' DROP DEFAULT';
	ELSE
		
		IF (DEFAULT_VALUE_W <> '') THEN
			IF ((COMP.IS_NUMBER(DEFAULT_VALUE_W)) OR (DEFAULT_VALUE_W = 'CURRENT_DATE') OR (DEFAULT_VALUE_W = 'CURRENT_TIMESTAMP')) THEN
				TEXT_W := TEXT_W || ' ALTER COLUMN ' || ATTRIBUTE_NAME_W || ' SET DEFAULT ' || DEFAULT_VALUE_W;
			ELSE
				TEXT_W := TEXT_W || ' ALTER COLUMN ' || ATTRIBUTE_NAME_W || ' SET DEFAULT ''' || DEFAULT_VALUE_W || '''';
			END IF;
		END IF;

	END IF;	
ELSIF ('CHARACTER SIZE' = $2) THEN
		TEXT_W := TEXT_W || ' ALTER COLUMN ' || ATTRIBUTE_NAME_W || ' TYPE VARCHAR(' || ATTRIBUTE_SIZE_W || ')';
ELSIF ('NUMERIC SIZE' = $2) THEN
		TEXT_W := TEXT_W || ' ALTER COLUMN ' || ATTRIBUTE_NAME_W || ' TYPE NUMERIC(' || ATTRIBUTE_SIZE_W || ',' || DECIMAL_SIZE_W || ')';
END IF;

PERFORM COMP.EXECUTE_STATEMENT(TEXT_W);

END;
$BODY$
  LANGUAGE plpgsql VOLATILE
  COST 100;
