CREATE OR REPLACE FUNCTION comp.create_indexes(id_table numeric, id_application numeric, nm_schema character varying, id_index numeric)
 RETURNS void
 LANGUAGE plpgsql
AS $function$
DECLARE

REC 			RECORD;
SUB_REC			RECORD;
TEXT_W 			VARCHAR(4000) := '';
TABLE_NAME_W 	VARCHAR(50);

BEGIN

SELECT 	A.NAME 
INTO 	TABLE_NAME_W 
FROM 	COMP.SYSTEM_TABLE A 
WHERE 	A.ID = $1;

FOR REC IN
	SELECT 	A.ID,
			A.NAME
	FROM  	COMP.TABLE_INDEX A,
			COMP.TABLE_INDEX_ATTRIBUTE B,
			COMP.TABLE_ATTRIBUTE C,
			COMP.SYSTEM_TABLE D
	WHERE	B.ID_INDEX = A.ID
	AND		C.ID = B.ID_TABLE_ATTRIBUTE
	AND		C.ID_TABLE = D.ID
	AND		D.ID_APPLICATION = $2
	AND		D.ID = $1
	AND  	A.ID = $4
	GROUP BY	A.ID,
				A.NAME
	ORDER BY 	A.ID	
LOOP
	TEXT_W := 'CREATE INDEX ' || REC.NAME || ' ON ' || $3 || '.' || TABLE_NAME_W || ' (';

	FOR SUB_REC IN
		SELECT 	B.NAME
		FROM 	COMP.TABLE_INDEX_ATTRIBUTE A,
				COMP.TABLE_ATTRIBUTE B
		WHERE 	A.ID_INDEX = REC.ID
		AND		A.ID_TABLE_ATTRIBUTE = B.ID
		LOOP
			TEXT_W := TEXT_W || SUB_REC.NAME || ', ';
		END LOOP;
		TEXT_W := SUBSTRING(TEXT_W FROM 1 FOR (CHAR_LENGTH(TEXT_W) -2)) || ') ';
END LOOP;

TEXT_W := TEXT_W || ';';

PERFORM COMP.EXECUTE_STATEMENT(TEXT_W);

END;
$function$
